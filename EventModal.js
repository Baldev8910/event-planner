import { __awaiter } from "tslib";
import { Modal, Setting } from 'obsidian';
export class EventModal extends Modal {
    constructor(app, eventManager, date, eventIndex, onSave) {
        super(app);
        this.eventManager = eventManager;
        this.date = date;
        this.eventIndex = eventIndex;
        this.onSave = onSave;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('calendar-event-modal');
        // Modal title
        contentEl.createEl('h2', {
            text: this.eventIndex !== null ? 'Edit Event' : 'Add Event'
        });
        // Load existing event data if editing
        let existingEvent = null;
        if (this.eventIndex !== null) {
            const events = this.eventManager.getEventsForDate(this.date);
            existingEvent = events[this.eventIndex] || null;
        }
        // Date field
        new Setting(contentEl)
            .setName('Date')
            .addText(text => {
            text.setValue(this.date);
            text.setDisabled(true);
        });
        // Time field
        new Setting(contentEl)
            .setName('Time')
            .addText(text => {
            this.timeInput = text.inputEl;
            this.timeInput.type = 'time';
            this.timeInput.value = (existingEvent === null || existingEvent === void 0 ? void 0 : existingEvent.time) || '';
        });
        // Title field
        new Setting(contentEl)
            .setName('Title')
            .addText(text => {
            this.titleInput = text.inputEl;
            this.titleInput.placeholder = 'Event title';
            this.titleInput.value = (existingEvent === null || existingEvent === void 0 ? void 0 : existingEvent.title) || '';
        });
        // Description field
        new Setting(contentEl)
            .setName('Description')
            .setDesc('Optional event description')
            .addTextArea(text => {
            this.descInput = text.inputEl;
            this.descInput.rows = 3;
            this.descInput.value = (existingEvent === null || existingEvent === void 0 ? void 0 : existingEvent.desc) || '';
        });
        // Color field
        new Setting(contentEl)
            .setName('Border Color')
            .addColorPicker(color => {
            this.colorInput = color.inputEl;
            this.colorInput.value = (existingEvent === null || existingEvent === void 0 ? void 0 : existingEvent.color) || '#1CA08F';
        });
        // Buttons
        const buttonContainer = contentEl.createDiv({ cls: 'modal-button-container' });
        // Delete button (only show when editing)
        if (this.eventIndex !== null) {
            const deleteBtn = buttonContainer.createEl('button', {
                text: 'Delete',
                cls: 'mod-warning'
            });
            deleteBtn.addEventListener('click', () => this.handleDelete());
        }
        // Cancel button
        const cancelBtn = buttonContainer.createEl('button', { text: 'Cancel' });
        cancelBtn.addEventListener('click', () => this.close());
        // Save button
        const saveBtn = buttonContainer.createEl('button', {
            text: 'Save',
            cls: 'mod-cta'
        });
        saveBtn.addEventListener('click', () => this.handleSave());
    }
    handleSave() {
        return __awaiter(this, void 0, void 0, function* () {
            const event = {
                time: this.timeInput.value,
                title: this.titleInput.value,
                desc: this.descInput.value,
                color: this.colorInput.value
            };
            // Prevent empty events
            if (!event.title && !event.desc) {
                this.close();
                return;
            }
            if (this.eventIndex !== null) {
                // Update existing event
                yield this.eventManager.updateEvent(this.date, this.eventIndex, event);
            }
            else {
                // Add new event
                yield this.eventManager.addEvent(this.date, event);
            }
            this.onSave();
            this.close();
        });
    }
    handleDelete() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.eventIndex !== null) {
                yield this.eventManager.deleteEvent(this.date, this.eventIndex);
                this.onSave();
                this.close();
            }
        });
    }
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnRNb2RhbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkV2ZW50TW9kYWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBTyxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRy9DLE1BQU0sT0FBTyxVQUFXLFNBQVEsS0FBSztJQVduQyxZQUNFLEdBQVEsRUFDUixZQUEwQixFQUMxQixJQUFZLEVBQ1osVUFBeUIsRUFDekIsTUFBa0I7UUFFbEIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1gsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7UUFDakMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDdkIsQ0FBQztJQUVELE1BQU07UUFDSixNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQzNCLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNsQixTQUFTLENBQUMsUUFBUSxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFFM0MsY0FBYztRQUNkLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQ3ZCLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxXQUFXO1NBQzVELENBQUMsQ0FBQztRQUVILHNDQUFzQztRQUN0QyxJQUFJLGFBQWEsR0FBeUIsSUFBSSxDQUFDO1FBQy9DLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxJQUFJLEVBQUU7WUFDNUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDN0QsYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxDQUFDO1NBQ2pEO1FBRUQsYUFBYTtRQUNiLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQzthQUNuQixPQUFPLENBQUMsTUFBTSxDQUFDO2FBQ2YsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztRQUVMLGFBQWE7UUFDYixJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUM7YUFDbkIsT0FBTyxDQUFDLE1BQU0sQ0FBQzthQUNmLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNkLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUM5QixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxNQUFNLENBQUM7WUFDN0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsQ0FBQSxhQUFhLGFBQWIsYUFBYSx1QkFBYixhQUFhLENBQUUsSUFBSSxLQUFJLEVBQUUsQ0FBQztRQUNuRCxDQUFDLENBQUMsQ0FBQztRQUVMLGNBQWM7UUFDZCxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUM7YUFDbkIsT0FBTyxDQUFDLE9BQU8sQ0FBQzthQUNoQixPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDZCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEdBQUcsYUFBYSxDQUFDO1lBQzVDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxHQUFHLENBQUEsYUFBYSxhQUFiLGFBQWEsdUJBQWIsYUFBYSxDQUFFLEtBQUssS0FBSSxFQUFFLENBQUM7UUFDckQsQ0FBQyxDQUFDLENBQUM7UUFFTCxvQkFBb0I7UUFDcEIsSUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDO2FBQ25CLE9BQU8sQ0FBQyxhQUFhLENBQUM7YUFDdEIsT0FBTyxDQUFDLDRCQUE0QixDQUFDO2FBQ3JDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNsQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDOUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLENBQUEsYUFBYSxhQUFiLGFBQWEsdUJBQWIsYUFBYSxDQUFFLElBQUksS0FBSSxFQUFFLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7UUFFTCxjQUFjO1FBQ2QsSUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDO2FBQ25CLE9BQU8sQ0FBQyxjQUFjLENBQUM7YUFDdkIsY0FBYyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUksS0FBYSxDQUFDLE9BQU8sQ0FBQztZQUN6QyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssR0FBRyxDQUFBLGFBQWEsYUFBYixhQUFhLHVCQUFiLGFBQWEsQ0FBRSxLQUFLLEtBQUksU0FBUyxDQUFDO1FBQzVELENBQUMsQ0FBQyxDQUFDO1FBRUwsVUFBVTtRQUNWLE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxHQUFHLEVBQUUsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDO1FBRS9FLHlDQUF5QztRQUN6QyxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssSUFBSSxFQUFFO1lBQzVCLE1BQU0sU0FBUyxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFO2dCQUNuRCxJQUFJLEVBQUUsUUFBUTtnQkFDZCxHQUFHLEVBQUUsYUFBYTthQUNuQixDQUFDLENBQUM7WUFDSCxTQUFTLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1NBQ2hFO1FBRUQsZ0JBQWdCO1FBQ2hCLE1BQU0sU0FBUyxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDekUsU0FBUyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUV4RCxjQUFjO1FBQ2QsTUFBTSxPQUFPLEdBQUcsZUFBZSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUU7WUFDakQsSUFBSSxFQUFFLE1BQU07WUFDWixHQUFHLEVBQUUsU0FBUztTQUNmLENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVLLFVBQVU7O1lBQ2QsTUFBTSxLQUFLLEdBQWtCO2dCQUMzQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLO2dCQUMxQixLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLO2dCQUM1QixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLO2dCQUMxQixLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLO2FBQzdCLENBQUM7WUFFRix1QkFBdUI7WUFDdkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO2dCQUMvQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ2IsT0FBTzthQUNSO1lBRUQsSUFBSSxJQUFJLENBQUMsVUFBVSxLQUFLLElBQUksRUFBRTtnQkFDNUIsd0JBQXdCO2dCQUN4QixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsQ0FBQzthQUN4RTtpQkFBTTtnQkFDTCxnQkFBZ0I7Z0JBQ2hCLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQzthQUNwRDtZQUVELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNkLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNmLENBQUM7S0FBQTtJQUVLLFlBQVk7O1lBQ2hCLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxJQUFJLEVBQUU7Z0JBQzVCLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ2hFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDZCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDZDtRQUNILENBQUM7S0FBQTtJQUVELE9BQU87UUFDTCxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQzNCLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNwQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIE1vZGFsLCBTZXR0aW5nIH0gZnJvbSAnb2JzaWRpYW4nO1xyXG5pbXBvcnQgeyBFdmVudE1hbmFnZXIsIENhbGVuZGFyRXZlbnQgfSBmcm9tICcuL0V2ZW50TWFuYWdlcic7XHJcblxyXG5leHBvcnQgY2xhc3MgRXZlbnRNb2RhbCBleHRlbmRzIE1vZGFsIHtcclxuICBwcml2YXRlIGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyO1xyXG4gIHByaXZhdGUgZGF0ZTogc3RyaW5nO1xyXG4gIHByaXZhdGUgZXZlbnRJbmRleDogbnVtYmVyIHwgbnVsbDtcclxuICBwcml2YXRlIG9uU2F2ZTogKCkgPT4gdm9pZDtcclxuICBcclxuICBwcml2YXRlIHRpbWVJbnB1dDogSFRNTElucHV0RWxlbWVudDtcclxuICBwcml2YXRlIHRpdGxlSW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQ7XHJcbiAgcHJpdmF0ZSBkZXNjSW5wdXQ6IEhUTUxUZXh0QXJlYUVsZW1lbnQ7XHJcbiAgcHJpdmF0ZSBjb2xvcklucHV0OiBIVE1MSW5wdXRFbGVtZW50O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIGFwcDogQXBwLFxyXG4gICAgZXZlbnRNYW5hZ2VyOiBFdmVudE1hbmFnZXIsXHJcbiAgICBkYXRlOiBzdHJpbmcsXHJcbiAgICBldmVudEluZGV4OiBudW1iZXIgfCBudWxsLFxyXG4gICAgb25TYXZlOiAoKSA9PiB2b2lkXHJcbiAgKSB7XHJcbiAgICBzdXBlcihhcHApO1xyXG4gICAgdGhpcy5ldmVudE1hbmFnZXIgPSBldmVudE1hbmFnZXI7XHJcbiAgICB0aGlzLmRhdGUgPSBkYXRlO1xyXG4gICAgdGhpcy5ldmVudEluZGV4ID0gZXZlbnRJbmRleDtcclxuICAgIHRoaXMub25TYXZlID0gb25TYXZlO1xyXG4gIH1cclxuXHJcbiAgb25PcGVuKCk6IHZvaWQge1xyXG4gICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XHJcbiAgICBjb250ZW50RWwuZW1wdHkoKTtcclxuICAgIGNvbnRlbnRFbC5hZGRDbGFzcygnY2FsZW5kYXItZXZlbnQtbW9kYWwnKTtcclxuXHJcbiAgICAvLyBNb2RhbCB0aXRsZVxyXG4gICAgY29udGVudEVsLmNyZWF0ZUVsKCdoMicsIHsgXHJcbiAgICAgIHRleHQ6IHRoaXMuZXZlbnRJbmRleCAhPT0gbnVsbCA/ICdFZGl0IEV2ZW50JyA6ICdBZGQgRXZlbnQnIFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gTG9hZCBleGlzdGluZyBldmVudCBkYXRhIGlmIGVkaXRpbmdcclxuICAgIGxldCBleGlzdGluZ0V2ZW50OiBDYWxlbmRhckV2ZW50IHwgbnVsbCA9IG51bGw7XHJcbiAgICBpZiAodGhpcy5ldmVudEluZGV4ICE9PSBudWxsKSB7XHJcbiAgICAgIGNvbnN0IGV2ZW50cyA9IHRoaXMuZXZlbnRNYW5hZ2VyLmdldEV2ZW50c0ZvckRhdGUodGhpcy5kYXRlKTtcclxuICAgICAgZXhpc3RpbmdFdmVudCA9IGV2ZW50c1t0aGlzLmV2ZW50SW5kZXhdIHx8IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRGF0ZSBmaWVsZFxyXG4gICAgbmV3IFNldHRpbmcoY29udGVudEVsKVxyXG4gICAgICAuc2V0TmFtZSgnRGF0ZScpXHJcbiAgICAgIC5hZGRUZXh0KHRleHQgPT4ge1xyXG4gICAgICAgIHRleHQuc2V0VmFsdWUodGhpcy5kYXRlKTtcclxuICAgICAgICB0ZXh0LnNldERpc2FibGVkKHRydWUpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAvLyBUaW1lIGZpZWxkXHJcbiAgICBuZXcgU2V0dGluZyhjb250ZW50RWwpXHJcbiAgICAgIC5zZXROYW1lKCdUaW1lJylcclxuICAgICAgLmFkZFRleHQodGV4dCA9PiB7XHJcbiAgICAgICAgdGhpcy50aW1lSW5wdXQgPSB0ZXh0LmlucHV0RWw7XHJcbiAgICAgICAgdGhpcy50aW1lSW5wdXQudHlwZSA9ICd0aW1lJztcclxuICAgICAgICB0aGlzLnRpbWVJbnB1dC52YWx1ZSA9IGV4aXN0aW5nRXZlbnQ/LnRpbWUgfHwgJyc7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgIC8vIFRpdGxlIGZpZWxkXHJcbiAgICBuZXcgU2V0dGluZyhjb250ZW50RWwpXHJcbiAgICAgIC5zZXROYW1lKCdUaXRsZScpXHJcbiAgICAgIC5hZGRUZXh0KHRleHQgPT4ge1xyXG4gICAgICAgIHRoaXMudGl0bGVJbnB1dCA9IHRleHQuaW5wdXRFbDtcclxuICAgICAgICB0aGlzLnRpdGxlSW5wdXQucGxhY2Vob2xkZXIgPSAnRXZlbnQgdGl0bGUnO1xyXG4gICAgICAgIHRoaXMudGl0bGVJbnB1dC52YWx1ZSA9IGV4aXN0aW5nRXZlbnQ/LnRpdGxlIHx8ICcnO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAvLyBEZXNjcmlwdGlvbiBmaWVsZFxyXG4gICAgbmV3IFNldHRpbmcoY29udGVudEVsKVxyXG4gICAgICAuc2V0TmFtZSgnRGVzY3JpcHRpb24nKVxyXG4gICAgICAuc2V0RGVzYygnT3B0aW9uYWwgZXZlbnQgZGVzY3JpcHRpb24nKVxyXG4gICAgICAuYWRkVGV4dEFyZWEodGV4dCA9PiB7XHJcbiAgICAgICAgdGhpcy5kZXNjSW5wdXQgPSB0ZXh0LmlucHV0RWw7XHJcbiAgICAgICAgdGhpcy5kZXNjSW5wdXQucm93cyA9IDM7XHJcbiAgICAgICAgdGhpcy5kZXNjSW5wdXQudmFsdWUgPSBleGlzdGluZ0V2ZW50Py5kZXNjIHx8ICcnO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAvLyBDb2xvciBmaWVsZFxyXG4gICAgbmV3IFNldHRpbmcoY29udGVudEVsKVxyXG4gICAgICAuc2V0TmFtZSgnQm9yZGVyIENvbG9yJylcclxuICAgICAgLmFkZENvbG9yUGlja2VyKGNvbG9yID0+IHtcclxuICAgICAgICB0aGlzLmNvbG9ySW5wdXQgPSAoY29sb3IgYXMgYW55KS5pbnB1dEVsO1xyXG4gICAgICAgIHRoaXMuY29sb3JJbnB1dC52YWx1ZSA9IGV4aXN0aW5nRXZlbnQ/LmNvbG9yIHx8ICcjMUNBMDhGJztcclxuICAgICAgfSk7XHJcblxyXG4gICAgLy8gQnV0dG9uc1xyXG4gICAgY29uc3QgYnV0dG9uQ29udGFpbmVyID0gY29udGVudEVsLmNyZWF0ZURpdih7IGNsczogJ21vZGFsLWJ1dHRvbi1jb250YWluZXInIH0pO1xyXG5cclxuICAgIC8vIERlbGV0ZSBidXR0b24gKG9ubHkgc2hvdyB3aGVuIGVkaXRpbmcpXHJcbiAgICBpZiAodGhpcy5ldmVudEluZGV4ICE9PSBudWxsKSB7XHJcbiAgICAgIGNvbnN0IGRlbGV0ZUJ0biA9IGJ1dHRvbkNvbnRhaW5lci5jcmVhdGVFbCgnYnV0dG9uJywgeyBcclxuICAgICAgICB0ZXh0OiAnRGVsZXRlJyxcclxuICAgICAgICBjbHM6ICdtb2Qtd2FybmluZydcclxuICAgICAgfSk7XHJcbiAgICAgIGRlbGV0ZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuaGFuZGxlRGVsZXRlKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENhbmNlbCBidXR0b25cclxuICAgIGNvbnN0IGNhbmNlbEJ0biA9IGJ1dHRvbkNvbnRhaW5lci5jcmVhdGVFbCgnYnV0dG9uJywgeyB0ZXh0OiAnQ2FuY2VsJyB9KTtcclxuICAgIGNhbmNlbEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuY2xvc2UoKSk7XHJcblxyXG4gICAgLy8gU2F2ZSBidXR0b25cclxuICAgIGNvbnN0IHNhdmVCdG4gPSBidXR0b25Db250YWluZXIuY3JlYXRlRWwoJ2J1dHRvbicsIHsgXHJcbiAgICAgIHRleHQ6ICdTYXZlJyxcclxuICAgICAgY2xzOiAnbW9kLWN0YSdcclxuICAgIH0pO1xyXG4gICAgc2F2ZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHRoaXMuaGFuZGxlU2F2ZSgpKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGhhbmRsZVNhdmUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBldmVudDogQ2FsZW5kYXJFdmVudCA9IHtcclxuICAgICAgdGltZTogdGhpcy50aW1lSW5wdXQudmFsdWUsXHJcbiAgICAgIHRpdGxlOiB0aGlzLnRpdGxlSW5wdXQudmFsdWUsXHJcbiAgICAgIGRlc2M6IHRoaXMuZGVzY0lucHV0LnZhbHVlLFxyXG4gICAgICBjb2xvcjogdGhpcy5jb2xvcklucHV0LnZhbHVlXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFByZXZlbnQgZW1wdHkgZXZlbnRzXHJcbiAgICBpZiAoIWV2ZW50LnRpdGxlICYmICFldmVudC5kZXNjKSB7XHJcbiAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmV2ZW50SW5kZXggIT09IG51bGwpIHtcclxuICAgICAgLy8gVXBkYXRlIGV4aXN0aW5nIGV2ZW50XHJcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRNYW5hZ2VyLnVwZGF0ZUV2ZW50KHRoaXMuZGF0ZSwgdGhpcy5ldmVudEluZGV4LCBldmVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBBZGQgbmV3IGV2ZW50XHJcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRNYW5hZ2VyLmFkZEV2ZW50KHRoaXMuZGF0ZSwgZXZlbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMub25TYXZlKCk7XHJcbiAgICB0aGlzLmNsb3NlKCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBoYW5kbGVEZWxldGUoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAodGhpcy5ldmVudEluZGV4ICE9PSBudWxsKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRNYW5hZ2VyLmRlbGV0ZUV2ZW50KHRoaXMuZGF0ZSwgdGhpcy5ldmVudEluZGV4KTtcclxuICAgICAgdGhpcy5vblNhdmUoKTtcclxuICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb25DbG9zZSgpOiB2b2lkIHtcclxuICAgIGNvbnN0IHsgY29udGVudEVsIH0gPSB0aGlzO1xyXG4gICAgY29udGVudEVsLmVtcHR5KCk7XHJcbiAgfVxyXG59Il19