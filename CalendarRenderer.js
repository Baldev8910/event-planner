export class CalendarRenderer {
    constructor(container, eventManager, openEventModal, openEventListModal) {
        this.currentView = 'full';
        this.today = new Date();
        this.todayStr = this.today.toISOString().split('T')[0];
        this.year = this.today.getFullYear();
        this.currentMonth = this.today.getMonth();
        this.quarter = Math.ceil((this.currentMonth + 1) / 3);
        this.themes = {
            1: { title: 'Q1 - Winter/Spring Reset', subtitle: 'January – March' },
            2: { title: 'Q2 - Summer Surge', subtitle: 'April – June' },
            3: { title: 'Q3 - Monsoon Momentum', subtitle: 'July – September' },
            4: { title: 'Q4 - Winter Lock-In', subtitle: 'October – December' }
        };
        this.months = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        this.container = container;
        this.eventManager = eventManager;
        this.openEventModalCallback = openEventModal;
        this.openEventListModalCallback = openEventListModal;
    }
    render() {
        this.container.empty();
        const root = this.container.createDiv({ cls: 'cal-container' });
        // Create header
        this.createHeader(root);
        // Create grid container
        this.gridContainer = root.createDiv({ cls: 'cal-grid' });
        // Render calendar
        this.renderCalendar();
    }
    refresh() {
        this.renderCalendar();
    }
    createHeader(root) {
        const header = root.createDiv({ cls: 'cal-header' });
        const theme = this.themes[this.quarter];
        header.createDiv({ cls: 'cal-title', text: theme.title });
        header.createDiv({ cls: 'cal-sub', text: theme.subtitle });
        // Create toggle switch
        this.createToggleSwitch(header);
    }
    createToggleSwitch(header) {
        const toggleContainer = header.createDiv({ cls: 'cal-toggle-container' });
        const toggleSwitch = toggleContainer.createDiv({ cls: 'cal-toggle-switch' });
        const toggleKnob = toggleSwitch.createDiv({ cls: 'cal-toggle-knob' });
        toggleSwitch.createSpan({ cls: 'cal-toggle-label cal-toggle-year', text: 'Year' });
        toggleSwitch.createSpan({ cls: 'cal-toggle-label cal-toggle-month', text: 'Month' });
        toggleSwitch.createSpan({ cls: 'cal-toggle-label cal-toggle-week', text: 'Week' });
        let toggleState = 0;
        toggleSwitch.addEventListener('click', () => {
            toggleState = (toggleState + 1) % 3;
            toggleSwitch.removeClass('state-0', 'state-1', 'state-2');
            toggleSwitch.addClass(`state-${toggleState}`);
            if (toggleState === 0) {
                this.currentView = 'full';
            }
            else if (toggleState === 1) {
                this.currentView = 'month';
            }
            else {
                this.currentView = 'week';
            }
            this.renderCalendar();
        });
    }
    renderCalendar() {
        this.gridContainer.empty();
        let monthsToShow = [];
        if (this.currentView === 'full') {
            monthsToShow = Array.from({ length: 12 }, (_, i) => i);
        }
        else {
            monthsToShow = [this.currentMonth];
        }
        monthsToShow.forEach((mi) => {
            this.renderMonth(mi);
        });
        // Apply event borders
        setTimeout(() => this.applyEventBorders(), 100);
    }
    renderMonth(monthIndex) {
        const box = this.gridContainer.createDiv({ cls: 'cal-month' });
        box.createEl('h3', { text: this.months[monthIndex] });
        const cal = box.createDiv({ cls: 'cal-calendar' });
        // Weekday headers
        ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(d => {
            const wd = cal.createDiv({ cls: 'cal-wd' });
            if (d === 'Sun')
                wd.addClass('sunday');
            wd.setText(d);
        });
        // Calculate days
        const { startDay, endDay } = this.calculateDaysToShow(monthIndex);
        // Empty cells
        const firstDayOfMonth = this.getFirstDay(this.year, monthIndex);
        for (let i = 0; i < firstDayOfMonth; i++) {
            cal.createDiv({ cls: 'cal-day cal-empty' });
        }
        // Day cells
        for (let d = startDay; d <= endDay; d++) {
            const date = this.formatDate(this.year, monthIndex, d);
            const cell = cal.createDiv({ cls: 'cal-day', text: d.toString() });
            cell.dataset.date = date;
            if (date === this.todayStr) {
                cell.addClass('today');
            }
            // Right-click context menu
            cell.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                this.showContextMenu(e, date);
            });
            // Add tooltip
            this.addTooltip(cell, date);
        }
    }
    calculateDaysToShow(monthIndex) {
        const totalDays = this.getDaysInMonth(this.year, monthIndex);
        if (this.currentView === 'week') {
            const todayDayOfWeek = this.today.getDay();
            const mondayOffset = todayDayOfWeek === 0 ? -6 : 1 - todayDayOfWeek;
            const startDay = Math.max(1, this.today.getDate() + mondayOffset);
            const endDay = Math.min(totalDays, startDay + 6);
            return { startDay, endDay };
        }
        return { startDay: 1, endDay: totalDays };
    }
    showContextMenu(event, date) {
        // Remove existing context menu
        const existing = document.querySelector('.cal-context-menu');
        if (existing)
            existing.remove();
        const menu = document.body.createDiv({ cls: 'cal-context-menu' });
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        const addEvent = menu.createDiv({ cls: 'cal-context-item', text: 'Add Event' });
        addEvent.addEventListener('click', () => {
            this.openEventModalCallback(date, null);
            menu.remove();
        });
        const listEvents = menu.createDiv({ cls: 'cal-context-item', text: 'List Scheduled Events' });
        listEvents.addEventListener('click', () => {
            this.openEventListModalCallback(date);
            menu.remove();
        });
        // Close on outside click
        const closeMenu = () => {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 0);
    }
    addTooltip(cell, date) {
        const tooltip = document.body.createDiv({ cls: 'cal-tooltip' });
        tooltip.style.display = 'none';
        cell.addEventListener('mouseenter', (e) => {
            const events = this.eventManager.getEventsForDate(date);
            if (events.length === 0)
                return;
            tooltip.empty();
            tooltip.createDiv({ cls: 'cal-tooltip-date', text: date });
            events.forEach(evt => {
                const eventDiv = tooltip.createDiv({ cls: 'cal-tooltip-event' });
                eventDiv.style.borderLeftColor = evt.color;
                if (evt.time) {
                    eventDiv.createDiv({ cls: 'cal-tooltip-time', text: evt.time });
                }
                eventDiv.createDiv({ cls: 'cal-tooltip-title', text: evt.title || 'Untitled Event' });
                if (evt.desc) {
                    eventDiv.createDiv({ cls: 'cal-tooltip-desc', text: evt.desc });
                }
            });
            tooltip.createDiv({
                cls: 'cal-tooltip-count',
                text: `${events.length} event${events.length === 1 ? '' : 's'}`
            });
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY + 10) + 'px';
        });
        cell.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
        });
        cell.addEventListener('mousemove', (e) => {
            if (tooltip.style.display === 'block') {
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY + 10) + 'px';
            }
        });
    }
    applyEventBorders() {
        const events = this.eventManager.getEvents();
        Object.entries(events).forEach(([date, eventData]) => {
            const cell = this.container.querySelector(`[data-date="${date}"]`);
            if (!cell)
                return;
            cell.style.boxShadow = '';
            const eventArray = Array.isArray(eventData) ? eventData : [eventData];
            const colors = eventArray.map(evt => evt === null || evt === void 0 ? void 0 : evt.color).filter(Boolean);
            if (colors.length === 0)
                return;
            const shadows = colors.map((color, i) => {
                const width = 2 + (i * 2);
                return `inset 0 0 0 ${width}px ${color}`;
            }).join(', ');
            cell.style.boxShadow = shadows;
        });
    }
    getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }
    getFirstDay(year, month) {
        const day = new Date(year, month, 1).getDay();
        return day === 0 ? 6 : day - 1;
    }
    formatDate(year, month, day) {
        return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FsZW5kYXJSZW5kZXJlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNhbGVuZGFyUmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsTUFBTSxPQUFPLGdCQUFnQjtJQTBCM0IsWUFDRSxTQUFzQixFQUN0QixZQUEwQixFQUMxQixjQUFpRSxFQUNqRSxrQkFBMEM7UUEzQnBDLGdCQUFXLEdBQWEsTUFBTSxDQUFDO1FBSy9CLFVBQUssR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ25CLGFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxTQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNoQyxpQkFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDckMsWUFBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRWpELFdBQU0sR0FBRztZQUNmLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSwwQkFBMEIsRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUU7WUFDckUsQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLG1CQUFtQixFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUU7WUFDM0QsQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLFFBQVEsRUFBRSxrQkFBa0IsRUFBRTtZQUNuRSxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUscUJBQXFCLEVBQUUsUUFBUSxFQUFFLG9CQUFvQixFQUFFO1NBQ3BFLENBQUM7UUFFTSxXQUFNLEdBQUc7WUFDZixTQUFTLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU07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QUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO0lBQ3pGLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50TWFuYWdlciB9IGZyb20gJy4vRXZlbnRNYW5hZ2VyJztcclxuXHJcbmV4cG9ydCB0eXBlIFZpZXdNb2RlID0gJ2Z1bGwnIHwgJ21vbnRoJyB8ICd3ZWVrJztcclxuXHJcbmV4cG9ydCBjbGFzcyBDYWxlbmRhclJlbmRlcmVyIHtcclxuICBwcml2YXRlIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQ7XHJcbiAgcHJpdmF0ZSBldmVudE1hbmFnZXI6IEV2ZW50TWFuYWdlcjtcclxuICBwcml2YXRlIGN1cnJlbnRWaWV3OiBWaWV3TW9kZSA9ICdmdWxsJztcclxuICBwcml2YXRlIGdyaWRDb250YWluZXI6IEhUTUxFbGVtZW50O1xyXG4gIHByaXZhdGUgb3BlbkV2ZW50TW9kYWxDYWxsYmFjazogKGRhdGU6IHN0cmluZywgZXZlbnRJbmRleDogbnVtYmVyIHwgbnVsbCkgPT4gdm9pZDtcclxuICBwcml2YXRlIG9wZW5FdmVudExpc3RNb2RhbENhbGxiYWNrOiAoZGF0ZTogc3RyaW5nKSA9PiB2b2lkO1xyXG5cclxuICBwcml2YXRlIHRvZGF5ID0gbmV3IERhdGUoKTtcclxuICBwcml2YXRlIHRvZGF5U3RyID0gdGhpcy50b2RheS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF07XHJcbiAgcHJpdmF0ZSB5ZWFyID0gdGhpcy50b2RheS5nZXRGdWxsWWVhcigpO1xyXG4gIHByaXZhdGUgY3VycmVudE1vbnRoID0gdGhpcy50b2RheS5nZXRNb250aCgpO1xyXG4gIHByaXZhdGUgcXVhcnRlciA9IE1hdGguY2VpbCgodGhpcy5jdXJyZW50TW9udGggKyAxKSAvIDMpO1xyXG5cclxuICBwcml2YXRlIHRoZW1lcyA9IHtcclxuICAgIDE6IHsgdGl0bGU6ICdRMSAtIFdpbnRlci9TcHJpbmcgUmVzZXQnLCBzdWJ0aXRsZTogJ0phbnVhcnkg4oCTIE1hcmNoJyB9LFxyXG4gICAgMjogeyB0aXRsZTogJ1EyIC0gU3VtbWVyIFN1cmdlJywgc3VidGl0bGU6ICdBcHJpbCDigJMgSnVuZScgfSxcclxuICAgIDM6IHsgdGl0bGU6ICdRMyAtIE1vbnNvb24gTW9tZW50dW0nLCBzdWJ0aXRsZTogJ0p1bHkg4oCTIFNlcHRlbWJlcicgfSxcclxuICAgIDQ6IHsgdGl0bGU6ICdRNCAtIFdpbnRlciBMb2NrLUluJywgc3VidGl0bGU6ICdPY3RvYmVyIOKAkyBEZWNlbWJlcicgfVxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgbW9udGhzID0gW1xyXG4gICAgJ0phbnVhcnknLCAnRmVicnVhcnknLCAnTWFyY2gnLCAnQXByaWwnLCAnTWF5JywgJ0p1bmUnLFxyXG4gICAgJ0p1bHknLCAnQXVndXN0JywgJ1NlcHRlbWJlcicsICdPY3RvYmVyJywgJ05vdmVtYmVyJywgJ0RlY2VtYmVyJ1xyXG4gIF07XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgY29udGFpbmVyOiBIVE1MRWxlbWVudCxcclxuICAgIGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyLFxyXG4gICAgb3BlbkV2ZW50TW9kYWw6IChkYXRlOiBzdHJpbmcsIGV2ZW50SW5kZXg6IG51bWJlciB8IG51bGwpID0+IHZvaWQsXHJcbiAgICBvcGVuRXZlbnRMaXN0TW9kYWw6IChkYXRlOiBzdHJpbmcpID0+IHZvaWRcclxuICApIHtcclxuICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyO1xyXG4gICAgdGhpcy5ldmVudE1hbmFnZXIgPSBldmVudE1hbmFnZXI7XHJcbiAgICB0aGlzLm9wZW5FdmVudE1vZGFsQ2FsbGJhY2sgPSBvcGVuRXZlbnRNb2RhbDtcclxuICAgIHRoaXMub3BlbkV2ZW50TGlzdE1vZGFsQ2FsbGJhY2sgPSBvcGVuRXZlbnRMaXN0TW9kYWw7XHJcbiAgfVxyXG5cclxuICByZW5kZXIoKTogdm9pZCB7XHJcbiAgICB0aGlzLmNvbnRhaW5lci5lbXB0eSgpO1xyXG5cclxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLmNvbnRhaW5lci5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtY29udGFpbmVyJyB9KTtcclxuXHJcbiAgICAvLyBDcmVhdGUgaGVhZGVyXHJcbiAgICB0aGlzLmNyZWF0ZUhlYWRlcihyb290KTtcclxuXHJcbiAgICAvLyBDcmVhdGUgZ3JpZCBjb250YWluZXJcclxuICAgIHRoaXMuZ3JpZENvbnRhaW5lciA9IHJvb3QuY3JlYXRlRGl2KHsgY2xzOiAnY2FsLWdyaWQnIH0pO1xyXG5cclxuICAgIC8vIFJlbmRlciBjYWxlbmRhclxyXG4gICAgdGhpcy5yZW5kZXJDYWxlbmRhcigpO1xyXG4gIH1cclxuXHJcbiAgcmVmcmVzaCgpOiB2b2lkIHtcclxuICAgIHRoaXMucmVuZGVyQ2FsZW5kYXIoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlSGVhZGVyKHJvb3Q6IEhUTUxFbGVtZW50KTogdm9pZCB7XHJcbiAgICBjb25zdCBoZWFkZXIgPSByb290LmNyZWF0ZURpdih7IGNsczogJ2NhbC1oZWFkZXInIH0pO1xyXG4gICAgXHJcbiAgICBjb25zdCB0aGVtZSA9IHRoaXMudGhlbWVzW3RoaXMucXVhcnRlciBhcyBrZXlvZiB0eXBlb2YgdGhpcy50aGVtZXNdO1xyXG4gICAgaGVhZGVyLmNyZWF0ZURpdih7IGNsczogJ2NhbC10aXRsZScsIHRleHQ6IHRoZW1lLnRpdGxlIH0pO1xyXG4gICAgaGVhZGVyLmNyZWF0ZURpdih7IGNsczogJ2NhbC1zdWInLCB0ZXh0OiB0aGVtZS5zdWJ0aXRsZSB9KTtcclxuXHJcbiAgICAvLyBDcmVhdGUgdG9nZ2xlIHN3aXRjaFxyXG4gICAgdGhpcy5jcmVhdGVUb2dnbGVTd2l0Y2goaGVhZGVyKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlVG9nZ2xlU3dpdGNoKGhlYWRlcjogSFRNTEVsZW1lbnQpOiB2b2lkIHtcclxuICAgIGNvbnN0IHRvZ2dsZUNvbnRhaW5lciA9IGhlYWRlci5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtdG9nZ2xlLWNvbnRhaW5lcicgfSk7XHJcbiAgICBjb25zdCB0b2dnbGVTd2l0Y2ggPSB0b2dnbGVDb250YWluZXIuY3JlYXRlRGl2KHsgY2xzOiAnY2FsLXRvZ2dsZS1zd2l0Y2gnIH0pO1xyXG4gICAgY29uc3QgdG9nZ2xlS25vYiA9IHRvZ2dsZVN3aXRjaC5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtdG9nZ2xlLWtub2InIH0pO1xyXG5cclxuICAgIHRvZ2dsZVN3aXRjaC5jcmVhdGVTcGFuKHsgY2xzOiAnY2FsLXRvZ2dsZS1sYWJlbCBjYWwtdG9nZ2xlLXllYXInLCB0ZXh0OiAnWWVhcicgfSk7XHJcbiAgICB0b2dnbGVTd2l0Y2guY3JlYXRlU3Bhbih7IGNsczogJ2NhbC10b2dnbGUtbGFiZWwgY2FsLXRvZ2dsZS1tb250aCcsIHRleHQ6ICdNb250aCcgfSk7XHJcbiAgICB0b2dnbGVTd2l0Y2guY3JlYXRlU3Bhbih7IGNsczogJ2NhbC10b2dnbGUtbGFiZWwgY2FsLXRvZ2dsZS13ZWVrJywgdGV4dDogJ1dlZWsnIH0pO1xyXG5cclxuICAgIGxldCB0b2dnbGVTdGF0ZSA9IDA7XHJcblxyXG4gICAgdG9nZ2xlU3dpdGNoLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICB0b2dnbGVTdGF0ZSA9ICh0b2dnbGVTdGF0ZSArIDEpICUgMztcclxuXHJcbiAgICAgIHRvZ2dsZVN3aXRjaC5yZW1vdmVDbGFzcygnc3RhdGUtMCcsICdzdGF0ZS0xJywgJ3N0YXRlLTInKTtcclxuICAgICAgdG9nZ2xlU3dpdGNoLmFkZENsYXNzKGBzdGF0ZS0ke3RvZ2dsZVN0YXRlfWApO1xyXG5cclxuICAgICAgaWYgKHRvZ2dsZVN0YXRlID09PSAwKSB7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50VmlldyA9ICdmdWxsJztcclxuICAgICAgfSBlbHNlIGlmICh0b2dnbGVTdGF0ZSA9PT0gMSkge1xyXG4gICAgICAgIHRoaXMuY3VycmVudFZpZXcgPSAnbW9udGgnO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuY3VycmVudFZpZXcgPSAnd2Vlayc7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMucmVuZGVyQ2FsZW5kYXIoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW5kZXJDYWxlbmRhcigpOiB2b2lkIHtcclxuICAgIHRoaXMuZ3JpZENvbnRhaW5lci5lbXB0eSgpO1xyXG5cclxuICAgIGxldCBtb250aHNUb1Nob3c6IG51bWJlcltdID0gW107XHJcblxyXG4gICAgaWYgKHRoaXMuY3VycmVudFZpZXcgPT09ICdmdWxsJykge1xyXG4gICAgICBtb250aHNUb1Nob3cgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiAxMiB9LCAoXywgaSkgPT4gaSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBtb250aHNUb1Nob3cgPSBbdGhpcy5jdXJyZW50TW9udGhdO1xyXG4gICAgfVxyXG5cclxuICAgIG1vbnRoc1RvU2hvdy5mb3JFYWNoKChtaSkgPT4ge1xyXG4gICAgICB0aGlzLnJlbmRlck1vbnRoKG1pKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIEFwcGx5IGV2ZW50IGJvcmRlcnNcclxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5hcHBseUV2ZW50Qm9yZGVycygpLCAxMDApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW5kZXJNb250aChtb250aEluZGV4OiBudW1iZXIpOiB2b2lkIHtcclxuICAgIGNvbnN0IGJveCA9IHRoaXMuZ3JpZENvbnRhaW5lci5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtbW9udGgnIH0pO1xyXG4gICAgYm94LmNyZWF0ZUVsKCdoMycsIHsgdGV4dDogdGhpcy5tb250aHNbbW9udGhJbmRleF0gfSk7XHJcblxyXG4gICAgY29uc3QgY2FsID0gYm94LmNyZWF0ZURpdih7IGNsczogJ2NhbC1jYWxlbmRhcicgfSk7XHJcblxyXG4gICAgLy8gV2Vla2RheSBoZWFkZXJzXHJcbiAgICBbJ01vbicsICdUdWUnLCAnV2VkJywgJ1RodScsICdGcmknLCAnU2F0JywgJ1N1biddLmZvckVhY2goZCA9PiB7XHJcbiAgICAgIGNvbnN0IHdkID0gY2FsLmNyZWF0ZURpdih7IGNsczogJ2NhbC13ZCcgfSk7XHJcbiAgICAgIGlmIChkID09PSAnU3VuJykgd2QuYWRkQ2xhc3MoJ3N1bmRheScpO1xyXG4gICAgICB3ZC5zZXRUZXh0KGQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQ2FsY3VsYXRlIGRheXNcclxuICAgIGNvbnN0IHsgc3RhcnREYXksIGVuZERheSB9ID0gdGhpcy5jYWxjdWxhdGVEYXlzVG9TaG93KG1vbnRoSW5kZXgpO1xyXG5cclxuICAgIC8vIEVtcHR5IGNlbGxzXHJcbiAgICBjb25zdCBmaXJzdERheU9mTW9udGggPSB0aGlzLmdldEZpcnN0RGF5KHRoaXMueWVhciwgbW9udGhJbmRleCk7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpcnN0RGF5T2ZNb250aDsgaSsrKSB7XHJcbiAgICAgIGNhbC5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtZGF5IGNhbC1lbXB0eScgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRGF5IGNlbGxzXHJcbiAgICBmb3IgKGxldCBkID0gc3RhcnREYXk7IGQgPD0gZW5kRGF5OyBkKyspIHtcclxuICAgICAgY29uc3QgZGF0ZSA9IHRoaXMuZm9ybWF0RGF0ZSh0aGlzLnllYXIsIG1vbnRoSW5kZXgsIGQpO1xyXG4gICAgICBjb25zdCBjZWxsID0gY2FsLmNyZWF0ZURpdih7IGNsczogJ2NhbC1kYXknLCB0ZXh0OiBkLnRvU3RyaW5nKCkgfSk7XHJcbiAgICAgIGNlbGwuZGF0YXNldC5kYXRlID0gZGF0ZTtcclxuXHJcbiAgICAgIGlmIChkYXRlID09PSB0aGlzLnRvZGF5U3RyKSB7XHJcbiAgICAgICAgY2VsbC5hZGRDbGFzcygndG9kYXknKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUmlnaHQtY2xpY2sgY29udGV4dCBtZW51XHJcbiAgICAgIGNlbGwuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCAoZSkgPT4ge1xyXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICB0aGlzLnNob3dDb250ZXh0TWVudShlLCBkYXRlKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBBZGQgdG9vbHRpcFxyXG4gICAgICB0aGlzLmFkZFRvb2x0aXAoY2VsbCwgZGF0ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNhbGN1bGF0ZURheXNUb1Nob3cobW9udGhJbmRleDogbnVtYmVyKTogeyBzdGFydERheTogbnVtYmVyOyBlbmREYXk6IG51bWJlciB9IHtcclxuICAgIGNvbnN0IHRvdGFsRGF5cyA9IHRoaXMuZ2V0RGF5c0luTW9udGgodGhpcy55ZWFyLCBtb250aEluZGV4KTtcclxuXHJcbiAgICBpZiAodGhpcy5jdXJyZW50VmlldyA9PT0gJ3dlZWsnKSB7XHJcbiAgICAgIGNvbnN0IHRvZGF5RGF5T2ZXZWVrID0gdGhpcy50b2RheS5nZXREYXkoKTtcclxuICAgICAgY29uc3QgbW9uZGF5T2Zmc2V0ID0gdG9kYXlEYXlPZldlZWsgPT09IDAgPyAtNiA6IDEgLSB0b2RheURheU9mV2VlaztcclxuICAgICAgY29uc3Qgc3RhcnREYXkgPSBNYXRoLm1heCgxLCB0aGlzLnRvZGF5LmdldERhdGUoKSArIG1vbmRheU9mZnNldCk7XHJcbiAgICAgIGNvbnN0IGVuZERheSA9IE1hdGgubWluKHRvdGFsRGF5cywgc3RhcnREYXkgKyA2KTtcclxuICAgICAgcmV0dXJuIHsgc3RhcnREYXksIGVuZERheSB9O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB7IHN0YXJ0RGF5OiAxLCBlbmREYXk6IHRvdGFsRGF5cyB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzaG93Q29udGV4dE1lbnUoZXZlbnQ6IE1vdXNlRXZlbnQsIGRhdGU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgLy8gUmVtb3ZlIGV4aXN0aW5nIGNvbnRleHQgbWVudVxyXG4gICAgY29uc3QgZXhpc3RpbmcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuY2FsLWNvbnRleHQtbWVudScpO1xyXG4gICAgaWYgKGV4aXN0aW5nKSBleGlzdGluZy5yZW1vdmUoKTtcclxuXHJcbiAgICBjb25zdCBtZW51ID0gZG9jdW1lbnQuYm9keS5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtY29udGV4dC1tZW51JyB9KTtcclxuICAgIG1lbnUuc3R5bGUubGVmdCA9IGV2ZW50LnBhZ2VYICsgJ3B4JztcclxuICAgIG1lbnUuc3R5bGUudG9wID0gZXZlbnQucGFnZVkgKyAncHgnO1xyXG5cclxuICAgIGNvbnN0IGFkZEV2ZW50ID0gbWVudS5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtY29udGV4dC1pdGVtJywgdGV4dDogJ0FkZCBFdmVudCcgfSk7XHJcbiAgICBhZGRFdmVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgdGhpcy5vcGVuRXZlbnRNb2RhbENhbGxiYWNrKGRhdGUsIG51bGwpO1xyXG4gICAgICBtZW51LnJlbW92ZSgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgbGlzdEV2ZW50cyA9IG1lbnUuY3JlYXRlRGl2KHsgY2xzOiAnY2FsLWNvbnRleHQtaXRlbScsIHRleHQ6ICdMaXN0IFNjaGVkdWxlZCBFdmVudHMnIH0pO1xyXG4gICAgbGlzdEV2ZW50cy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgdGhpcy5vcGVuRXZlbnRMaXN0TW9kYWxDYWxsYmFjayhkYXRlKTtcclxuICAgICAgbWVudS5yZW1vdmUoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIENsb3NlIG9uIG91dHNpZGUgY2xpY2tcclxuICAgIGNvbnN0IGNsb3NlTWVudSA9ICgpID0+IHtcclxuICAgICAgbWVudS5yZW1vdmUoKTtcclxuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjbG9zZU1lbnUpO1xyXG4gICAgfTtcclxuICAgIHNldFRpbWVvdXQoKCkgPT4gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjbG9zZU1lbnUpLCAwKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWRkVG9vbHRpcChjZWxsOiBIVE1MRWxlbWVudCwgZGF0ZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCB0b29sdGlwID0gZG9jdW1lbnQuYm9keS5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtdG9vbHRpcCcgfSk7XHJcbiAgICB0b29sdGlwLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XHJcblxyXG4gICAgY2VsbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKGUpID0+IHtcclxuICAgICAgY29uc3QgZXZlbnRzID0gdGhpcy5ldmVudE1hbmFnZXIuZ2V0RXZlbnRzRm9yRGF0ZShkYXRlKTtcclxuICAgICAgaWYgKGV2ZW50cy5sZW5ndGggPT09IDApIHJldHVybjtcclxuXHJcbiAgICAgIHRvb2x0aXAuZW1wdHkoKTtcclxuICAgICAgdG9vbHRpcC5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtdG9vbHRpcC1kYXRlJywgdGV4dDogZGF0ZSB9KTtcclxuXHJcbiAgICAgIGV2ZW50cy5mb3JFYWNoKGV2dCA9PiB7XHJcbiAgICAgICAgY29uc3QgZXZlbnREaXYgPSB0b29sdGlwLmNyZWF0ZURpdih7IGNsczogJ2NhbC10b29sdGlwLWV2ZW50JyB9KTtcclxuICAgICAgICBldmVudERpdi5zdHlsZS5ib3JkZXJMZWZ0Q29sb3IgPSBldnQuY29sb3I7XHJcblxyXG4gICAgICAgIGlmIChldnQudGltZSkge1xyXG4gICAgICAgICAgZXZlbnREaXYuY3JlYXRlRGl2KHsgY2xzOiAnY2FsLXRvb2x0aXAtdGltZScsIHRleHQ6IGV2dC50aW1lIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBldmVudERpdi5jcmVhdGVEaXYoeyBjbHM6ICdjYWwtdG9vbHRpcC10aXRsZScsIHRleHQ6IGV2dC50aXRsZSB8fCAnVW50aXRsZWQgRXZlbnQnIH0pO1xyXG4gICAgICAgIGlmIChldnQuZGVzYykge1xyXG4gICAgICAgICAgZXZlbnREaXYuY3JlYXRlRGl2KHsgY2xzOiAnY2FsLXRvb2x0aXAtZGVzYycsIHRleHQ6IGV2dC5kZXNjIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0b29sdGlwLmNyZWF0ZURpdih7IFxyXG4gICAgICAgIGNsczogJ2NhbC10b29sdGlwLWNvdW50JywgXHJcbiAgICAgICAgdGV4dDogYCR7ZXZlbnRzLmxlbmd0aH0gZXZlbnQke2V2ZW50cy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ31gIFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRvb2x0aXAuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XHJcbiAgICAgIHRvb2x0aXAuc3R5bGUubGVmdCA9IChlLnBhZ2VYICsgMTApICsgJ3B4JztcclxuICAgICAgdG9vbHRpcC5zdHlsZS50b3AgPSAoZS5wYWdlWSArIDEwKSArICdweCc7XHJcbiAgICB9KTtcclxuXHJcbiAgICBjZWxsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCAoKSA9PiB7XHJcbiAgICAgIHRvb2x0aXAuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgIH0pO1xyXG5cclxuICAgIGNlbGwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGUpID0+IHtcclxuICAgICAgaWYgKHRvb2x0aXAuc3R5bGUuZGlzcGxheSA9PT0gJ2Jsb2NrJykge1xyXG4gICAgICAgIHRvb2x0aXAuc3R5bGUubGVmdCA9IChlLnBhZ2VYICsgMTApICsgJ3B4JztcclxuICAgICAgICB0b29sdGlwLnN0eWxlLnRvcCA9IChlLnBhZ2VZICsgMTApICsgJ3B4JztcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFwcGx5RXZlbnRCb3JkZXJzKCk6IHZvaWQge1xyXG4gICAgY29uc3QgZXZlbnRzID0gdGhpcy5ldmVudE1hbmFnZXIuZ2V0RXZlbnRzKCk7XHJcblxyXG4gICAgT2JqZWN0LmVudHJpZXMoZXZlbnRzKS5mb3JFYWNoKChbZGF0ZSwgZXZlbnREYXRhXSkgPT4ge1xyXG4gICAgICBjb25zdCBjZWxsID0gdGhpcy5jb250YWluZXIucXVlcnlTZWxlY3RvcihgW2RhdGEtZGF0ZT1cIiR7ZGF0ZX1cIl1gKSBhcyBIVE1MRWxlbWVudDtcclxuICAgICAgaWYgKCFjZWxsKSByZXR1cm47XHJcblxyXG4gICAgICBjZWxsLnN0eWxlLmJveFNoYWRvdyA9ICcnO1xyXG5cclxuICAgICAgY29uc3QgZXZlbnRBcnJheSA9IEFycmF5LmlzQXJyYXkoZXZlbnREYXRhKSA/IGV2ZW50RGF0YSA6IFtldmVudERhdGFdO1xyXG4gICAgICBjb25zdCBjb2xvcnMgPSBldmVudEFycmF5Lm1hcChldnQgPT4gZXZ0Py5jb2xvcikuZmlsdGVyKEJvb2xlYW4pO1xyXG5cclxuICAgICAgaWYgKGNvbG9ycy5sZW5ndGggPT09IDApIHJldHVybjtcclxuXHJcbiAgICAgIGNvbnN0IHNoYWRvd3MgPSBjb2xvcnMubWFwKChjb2xvciwgaSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHdpZHRoID0gMiArIChpICogMik7XHJcbiAgICAgICAgcmV0dXJuIGBpbnNldCAwIDAgMCAke3dpZHRofXB4ICR7Y29sb3J9YDtcclxuICAgICAgfSkuam9pbignLCAnKTtcclxuXHJcbiAgICAgIGNlbGwuc3R5bGUuYm94U2hhZG93ID0gc2hhZG93cztcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXREYXlzSW5Nb250aCh5ZWFyOiBudW1iZXIsIG1vbnRoOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIG5ldyBEYXRlKHllYXIsIG1vbnRoICsgMSwgMCkuZ2V0RGF0ZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRGaXJzdERheSh5ZWFyOiBudW1iZXIsIG1vbnRoOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgY29uc3QgZGF5ID0gbmV3IERhdGUoeWVhciwgbW9udGgsIDEpLmdldERheSgpO1xyXG4gICAgcmV0dXJuIGRheSA9PT0gMCA/IDYgOiBkYXkgLSAxO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBmb3JtYXREYXRlKHllYXI6IG51bWJlciwgbW9udGg6IG51bWJlciwgZGF5OiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGAke3llYXJ9LSR7U3RyaW5nKG1vbnRoICsgMSkucGFkU3RhcnQoMiwgJzAnKX0tJHtTdHJpbmcoZGF5KS5wYWRTdGFydCgyLCAnMCcpfWA7XHJcbiAgfVxyXG59Il19